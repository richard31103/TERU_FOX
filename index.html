<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title id="lang-ui-docTitle">TERU FOX</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@400;700&family=Cinzel:wght@600&family=Orbitron:wght@700&family=M+PLUS+Rounded+1c:wght@700&display=swap"
        rel="stylesheet" />
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --char-focus-x: 50%;
            --char-focus-y: 22%;
        }

        @media (max-height: 820px) {
            :root {
                --char-focus-y: 18%;
            }
        }

        @media (max-height: 720px) {
            :root {
                --char-focus-y: 14%;
            }
        }

        html,
        body {
            width: 100%;
            height: 100%;
            background: #000000;
            font-family: 'Noto Serif TC', serif;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* ???? Game Container ???? */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100dvh;
            /* dynamic viewport height: excludes browser chrome on iOS */
            padding-bottom: env(safe-area-inset-bottom);
            /* iPhone home bar */
            overflow: hidden;
            cursor: pointer;
        }

        /* ???? Background splash (shows BG.jpg until game starts) ???? */
        #bg-splash {
            position: absolute;
            inset: 0;
            background: url('BG.jpg') center/cover no-repeat;
            z-index: 6;
            opacity: 1;
            transition: opacity 1.4s ease;
            pointer-events: none;
        }

        #bg-splash.fade-out {
            opacity: 0;
        }

        /* ???? Background ???? */
        #bg {
            position: absolute;
            inset: 0;
            background: url('BG.jpg') center/cover no-repeat #000;
            filter: brightness(0.9);
            transition: filter 0.6s;
            animation: bgFloat 12s ease-in-out infinite;
        }

        @keyframes bgFloat {

            0%,
            100% {
                transform: scale(1.02) translateY(0);
            }

            50% {
                transform: scale(1.02) translateY(-8px);
            }
        }

        /* ???? Vignette ???? */
        #vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 50% 50%, transparent 45%, rgba(0, 0, 0, 0.55) 100%);
            pointer-events: none;
        }

        /* ???? OOXX transition curtain ???? */
        #ooxx-curtain {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 102;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.55s ease;
        }

        #ooxx-curtain.dark {
            opacity: 1;
            pointer-events: all;
        }

        /* ???? Particles ???? */
        #particles-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            /* Changed from 2 to 10 to ensure it's above character container */
            overflow: hidden;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 240, 160, 0.85);
            /* Brighter base */
            box-shadow: 0 0 16px 4px rgba(250, 180, 60, 0.9);
            /* Stronger glow */
            opacity: 0;
            z-index: 15;
            /* Ensure it is above the vignette and background */
            animation: floatParticle 8s infinite alternate ease-in-out;
        }

        @keyframes floatParticle {
            0% {
                transform: translate(0, 0) scale(0.6);
                opacity: 0;
            }

            15% {
                opacity: 0.8;
            }

            85% {
                opacity: 0.8;
            }

            100% {
                transform: translate(var(--x-drift, 20px), -150px) scale(1.3);
                opacity: 0;
            }
        }

        /* ???? Character ???? */
        #character-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }

        .char-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: var(--char-focus-x, 50%) var(--char-focus-y, 22%);
            position: absolute;
            inset: 0;
            opacity: 0;
            /* No transition for fast flipping */
            /* transition: opacity 0.05s; */
        }

        .char-img.active {
            opacity: 1;
        }

        #char-tail {
            z-index: 1;
            transform-origin: 68.7376% 75.0098%;
            animation: tailSway 2s ease-in-out infinite alternate;
            will-change: transform;
        }

        #char-body {
            z-index: 2;
        }

        #char-head-idle,
        #char-head-blink,
        #char-head-speak,
        #char-head-angry,
        #char-head-happy {
            z-index: 3;
        }

        #money-popup {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: var(--char-focus-x, 50%) var(--char-focus-y, 22%);
            opacity: 0;
            pointer-events: none;
            z-index: 42;
            transition: opacity 0.15s ease-out;
        }

        #money-popup.visible {
            opacity: 1;
        }

        @keyframes tailSway {
            from {
                transform: rotate(-2.5deg);
            }

            to {
                transform: rotate(2.5deg);
            }
        }

        /* ???? TOP BAR ???? */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 68px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.80) 0%, transparent 100%);
            z-index: 10;
        }

        #game-title {
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 3px;
            color: #f5d898;
            text-shadow: 0 0 18px rgba(245, 160, 30, 0.9), 0 0 5px rgba(0, 0, 0, 0.9);
        }

        .top-btn-group {
            display: flex;
            gap: 12px;
        }

        .top-btn {
            background: rgba(40, 20, 5, 0.45);
            border: 1.5px solid rgba(220, 150, 50, 0.30);
            color: #f0d8a8;
            padding: 12px 28px;
            border-radius: 28px;
            font-size: 19px;
            font-family: 'Noto Sans TC', sans-serif;
            cursor: pointer;
            backdrop-filter: blur(6px);
            transition: background 0.2s, border-color 0.2s, transform 0.15s, color 0.2s;
        }

        .top-btn:hover {
            background: rgba(200, 100, 20, 0.40);
            border-color: rgba(230, 160, 40, 0.80);
            color: #fff0cc;
            transform: translateY(-2px);
        }

        .top-btn.active {
            background: rgba(200, 100, 20, 0.55);
            border-color: #e09030;
        }

        /* ???? CHAPTER BADGE ???? */
        #chapter-badge {
            position: absolute;
            top: 76px;
            left: 24px;
            background: linear-gradient(135deg, rgba(60, 25, 5, 0.90), rgba(25, 10, 2, 0.90));
            border: 2px solid rgba(220, 140, 40, 0.50);
            border-radius: 12px;
            padding: 14px 26px;
            z-index: 10;
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease;
        }

        #chapter-badge .ch-label {
            font-size: 15px;
            color: #c8903a;
            letter-spacing: 4px;
            font-family: 'Cinzel', serif;
        }

        #chapter-badge .ch-title {
            font-size: 24px;
            color: #f0d8a0;
            margin-top: 6px;
            font-weight: 700;
        }

        /* ???? QUICK ACTIONS ???? */
        #quick-actions {
            position: absolute;
            right: 24px;
            top: 76px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .qa-btn {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: rgba(20, 8, 0, 0.65);
            border: 2px solid rgba(220, 140, 40, 0.32);
            color: #f0cc80;
            font-size: 28px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(6px);
            transition: all 0.2s;
            position: relative;
        }

        .qa-btn:hover {
            background: rgba(180, 80, 10, 0.60);
            border-color: #e09030;
            transform: scale(1.12);
            box-shadow: 0 0 18px rgba(220, 130, 20, 0.6);
        }

        .qa-btn .tooltip {
            position: absolute;
            right: 76px;
            background: rgba(30, 10, 0, 0.95);
            color: #f0d898;
            font-size: 15px;
            white-space: nowrap;
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(220, 140, 40, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .qa-btn:hover .tooltip {
            opacity: 1;
        }

        /* ???????????????????????????????????????????????????????????????
           CHOICE PANEL (left side, vertical list)
        ??????????????????????????????????????????????????????????????? */
        #choice-panel {
            position: absolute;
            left: 48px;
            top: 50%;
            transform: translateY(-50%) translateX(-160px);
            width: 520px;
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 18px;
            opacity: 0;
            pointer-events: none;
            transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.45s ease;
        }

        #choice-panel.visible {
            transform: translateY(-50%) translateX(0);
            opacity: 1;
            pointer-events: all;
        }

        .choice-label {
            font-size: 22px;
            color: #d4a050;
            letter-spacing: 5px;
            margin-bottom: 10px;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 14px rgba(220, 140, 30, 0.85);
        }

        .choice-btn {
            display: flex;
            align-items: center;
            gap: 18px;
            background: linear-gradient(135deg, rgba(40, 15, 2, 0.82), rgba(15, 6, 0, 0.82));
            border: 2px solid rgba(200, 120, 30, 0.38);
            border-radius: 16px;
            padding: 20px 24px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.22s;
            text-align: left;
            width: 100%;
            font-family: 'Noto Serif TC', serif;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, rgba(160, 60, 10, 0.70), rgba(100, 40, 5, 0.70));
            border-color: rgba(240, 170, 50, 0.80);
            transform: translateX(8px);
            box-shadow: 0 0 22px rgba(210, 120, 20, 0.50);
        }

        .choice-num {
            min-width: 38px;
            height: 38px;
            border-radius: 50%;
            background: linear-gradient(135deg, #b05010, #7a2e00);
            color: #ffe8b0;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 0 12px rgba(210, 110, 20, 0.6);
        }

        .choice-text {
            font-size: 20px;
            color: #f5e8c8;
            line-height: 1.55;
            text-shadow: 0 1px 8px rgba(0, 0, 0, 1), 0 0 2px rgba(0, 0, 0, 0.8);
            letter-spacing: 0.5px;
        }

        /* ???? DIALOGUE AREA ???? */
        #dialogue-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 160px;
            z-index: 20;
            transition: opacity 0.15s ease-out;
        }

        #dialogue-area.money-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Glass backdrop ??warm semi-transparent */
        #dialogue-box {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom,
                    rgba(15, 6, 0, 0.42) 0%,
                    rgba(30, 10, 0, 0.62) 100%);
            backdrop-filter: blur(6px);
            border-top: 1px solid rgba(200, 120, 30, 0.38);
        }

        /* Warm neon top line */
        #dialogue-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 4%;
            right: 4%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #e08020, #ffd060, #e08020, transparent);
            box-shadow: 0 0 14px rgba(220, 140, 20, 0.85);
        }

        /* Name plate */
        #speaker-plate {
            position: absolute;
            top: -40px;
            left: 40px;
            background: linear-gradient(135deg, #8b3200, #c06010);
            border: 2px solid rgba(240, 170, 60, 0.60);
            border-radius: 12px 12px 0 0;
            padding: 10px 36px 6px;
            font-size: 24px;
            font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif;
            font-weight: 700;
            color: #fff0cc;
            letter-spacing: 4px;
            text-shadow: 0 0 12px rgba(240, 160, 40, 0.9);
            box-shadow: 0 -5px 22px rgba(160, 70, 10, 0.60);
        }

        /* Dialogue text + inline blinking cursor */
        #dialogue-text {
            position: absolute;
            top: 32px;
            left: 40px;
            right: 40px;
            bottom: 52px;
            font-size: 26px;
            /* Increased from 22px to 26px */
            line-height: 1.75;
            color: #f8efd8;
            text-shadow: 0 1px 8px rgba(0, 0, 0, 1), 0 0 2px rgba(0, 0, 0, 1);
            letter-spacing: 1px;
        }

        /* Inline typing cursor ??only visible while .typing class is present */
        #dialogue-text.typing::after {
            content: '|';
            color: #f0ae40;
            text-shadow: 0 0 10px rgba(220, 140, 20, 0.95);
            animation: cursorBlink 0.65s steps(1) infinite;
            margin-left: 2px;
        }

        @keyframes cursorBlink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* ??end-of-line indicator ??shown when NOT typing */
        #next-indicator {
            position: absolute;
            right: 32px;
            bottom: 58px;
            font-size: 16px;
            color: #f0ae40;
            text-shadow: 0 0 10px rgba(220, 140, 20, 0.9);
            opacity: 0;
            transition: opacity 0.2s;
            animation: arrowBlink 0.9s ease-in-out infinite;
        }

        /* Show ??only when NOT typing */
        #dialogue-text:not(.typing)~#next-indicator {
            opacity: 1;
        }

        @keyframes arrowBlink {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 1;
            }

            30% {
                transform: translateY(4px);
                opacity: 0.25;
            }
        }

        /* ???? BOTTOM CONTROLS BAR ???? */
        #controls-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            border-top: 1px solid rgba(200, 120, 30, 0.22);
        }

        .ctrl-btn-group {
            display: flex;
            gap: 8px;
        }

        .ctrl-btn {
            background: rgba(40, 15, 0, 0.45);
            border: 1.5px solid rgba(200, 120, 30, 0.28);
            color: #e8c880;
            padding: 7px 18px;
            border-radius: 18px;
            font-size: 14px;
            font-family: 'Noto Serif TC', serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ctrl-btn:hover {
            background: rgba(160, 65, 10, 0.45);
            border-color: rgba(230, 150, 40, 0.75);
            color: #fff0c0;
            transform: translateY(-1px);
        }

        .ctrl-btn.primary {
            background: linear-gradient(135deg, rgba(150, 55, 10, 0.80), rgba(100, 35, 5, 0.80));
            border-color: rgba(230, 150, 40, 0.55);
            color: #fff0cc;
        }

        .ctrl-btn.primary:hover {
            background: linear-gradient(135deg, rgba(190, 75, 15, 0.90), rgba(130, 50, 8, 0.90));
            box-shadow: 0 0 18px rgba(210, 110, 20, 0.55);
        }

        /* ???? TITLE AND DEATH SCREENS ???? */
        .overlay-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            opacity: 1;
            transition: opacity 1s ease;
        }

        .overlay-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #title-screen h1 {
            font-family: 'Cinzel', 'Noto Serif TC', serif;
            font-size: 64px;
            color: #f5d898;
            margin-bottom: 40px;
            text-shadow: 0 0 30px rgba(245, 160, 30, 0.8);
            letter-spacing: 8px;
        }

        #start-btn {
            background: transparent;
            border: 2px solid rgba(245, 160, 30, 0.8);
            color: #f5d898;
            font-size: 24px;
            padding: 16px 48px;
            border-radius: 36px;
            cursor: pointer;
            font-family: 'Noto Serif TC', serif;
            letter-spacing: 4px;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(245, 160, 30, 0.3) inset, 0 0 15px rgba(245, 160, 30, 0.3);
        }

        #start-btn:hover {
            background: rgba(245, 160, 30, 0.2);
            box-shadow: 0 0 25px rgba(245, 160, 30, 0.6) inset, 0 0 25px rgba(245, 160, 30, 0.6);
            transform: scale(1.05);
        }

        #death-screen {
            background: #000;
            pointer-events: none;
        }

        #death-screen:not(.hidden) {
            pointer-events: auto;
            /* Catch clicks so they don't hit game-container */
        }

        #death-text {
            color: #cc0000;
            font-size: 56px;
            font-family: 'Noto Serif TC', serif;
            font-weight: bold;
            letter-spacing: 12px;
            text-shadow: 0 0 20px #ff0000;
            opacity: 0;
            transition: opacity 2s ease;
        }

        #death-screen.show-text #death-text {
            opacity: 1;
        }

        #to-be-continued-screen {
            background: #000;
            z-index: 101;
        }

        #to-be-continued-text {
            position: absolute;
            right: 42px;
            bottom: 34px;
            color: #ffffff;
            font-size: clamp(26px, 3.2vw, 48px);
            letter-spacing: 4px;
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.35);
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 0.7s ease 0.25s, transform 0.7s ease 0.25s;
        }

        #to-be-continued-screen:not(.hidden) #to-be-continued-text {
            opacity: 1;
            transform: translateY(0);
        }

        /* ???? MAP OVERLAY ???? */
        #map-overlay {
            background: rgba(10, 5, 0, 0.90);
            backdrop-filter: blur(8px);
        }

        #map-overlay img {
            max-width: 90%;
            max-height: 85%;
            border: 2px solid rgba(220, 140, 40, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(180, 90, 10, 0.6);
        }

        #close-map {
            position: absolute;
            top: 40px;
            right: 60px;
            background: rgba(200, 50, 0, 0.8);
            color: #fff;
            border: 2px solid rgba(255, 100, 50, 0.8);
            font-size: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background 0.2s;
        }

        #close-map:hover {
            transform: scale(1.1);
            background: rgba(255, 80, 20, 0.9);
        }

        /* ???? LOADING BAR ???? */
        #loading-container {
            width: 300px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: opacity 0.4s;
        }

        #loading-text {
            color: #f5d898;
            font-size: 14px;
            letter-spacing: 2px;
        }

        #loading-bar-bg {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(220, 150, 40, 0.3);
        }

        #loading-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #d4a050, #ffcc66);
            transition: width 0.3s ease;
        }

        /* ???? HISTORY OVERLAY ???? */
        #history-overlay {
            background: rgba(15, 8, 5, 0.95);
            backdrop-filter: blur(12px);
        }

        #history-panel {
            width: 700px;
            height: 80vh;
            background: linear-gradient(160deg, rgba(40, 15, 5, 0.9), rgba(15, 6, 2, 0.9));
            border: 1.5px solid rgba(220, 140, 40, 0.6);
            border-radius: 16px;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(160, 80, 10, 0.5);
        }

        #history-panel h2 {
            font-family: 'Cinzel', 'Noto Serif TC', serif;
            color: #f0c060;
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            letter-spacing: 4px;
            text-shadow: 0 0 10px rgba(220, 150, 20, 0.8);
        }

        #history-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Custom scrollbar for history */
        #history-list::-webkit-scrollbar {
            width: 8px;
        }

        #history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        #history-list::-webkit-scrollbar-thumb {
            background: rgba(200, 120, 30, 0.5);
            border-radius: 4px;
        }

        .history-entry {
            border-bottom: 1px solid rgba(220, 140, 40, 0.2);
            padding-bottom: 12px;
        }

        .history-speaker {
            color: #d4a050;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .history-text {
            color: #f5e8c8;
            font-size: 18px;
            line-height: 1.6;
        }

        .history-choice {
            font-style: italic;
            color: #a0f0a0;
        }

        #close-history {
            margin-top: 24px;
            align-self: center;
            background: linear-gradient(135deg, #8b3200, #c06010);
            border: 1.5px solid rgba(240, 170, 60, 0.55);
            color: #fff0cc;
            padding: 10px 40px;
            border-radius: 24px;
            font-size: 16px;
            font-family: 'Noto Serif TC', serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        #close-history:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(220, 130, 20, 0.7);
        }

        /* ???? SETTINGS PANEL OVERLAY ???? */
        #settings-overlay {
            position: absolute;
            inset: 0;
            background: rgba(8, 3, 0, 0.88);
            backdrop-filter: blur(18px);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #settings-overlay.open {
            display: flex;
            opacity: 1;
        }

        #settings-panel {
            width: 540px;
            background: linear-gradient(160deg, rgba(45, 15, 2, 0.97), rgba(15, 5, 0, 0.97));
            border: 1.5px solid rgba(210, 130, 40, 0.45);
            border-radius: 18px;
            padding: 36px 44px;
            box-shadow: 0 0 60px rgba(180, 90, 10, 0.45);
        }

        #settings-panel h2 {
            font-family: 'Cinzel', serif;
            font-size: 18px;
            color: #f0c060;
            letter-spacing: 4px;
            margin-bottom: 28px;
            text-align: center;
            text-shadow: 0 0 14px rgba(220, 150, 20, 0.8);
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 22px;
        }

        .setting-label {
            color: #d4a860;
            font-size: 15px;
            letter-spacing: 1px;
        }

        .setting-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 220px;
            height: 5px;
            border-radius: 3px;
            background: linear-gradient(to right, #c06010 var(--val, 70%), rgba(255, 255, 255, 0.12) var(--val, 70%));
            outline: none;
            cursor: pointer;
        }

        .setting-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #f0a030;
            box-shadow: 0 0 10px rgba(220, 140, 20, 0.85);
            cursor: pointer;
        }

        .setting-toggle {
            display: flex;
            gap: 8px;
        }

        .tog-btn {
            padding: 6px 16px;
            border-radius: 14px;
            border: 1.5px solid rgba(200, 120, 30, 0.38);
            background: transparent;
            color: #b08040;
            font-size: 13px;
            font-family: 'Noto Serif TC', serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tog-btn.on {
            background: linear-gradient(135deg, #8b3200, #c06010);
            border-color: rgba(240, 170, 60, 0.60);
            color: #fff0cc;
        }

        .setting-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(210, 130, 40, 0.40), transparent);
            margin: 20px 0;
        }

        #close-settings {
            display: block;
            margin: 26px auto 0;
            padding: 11px 48px;
            border-radius: 26px;
            background: linear-gradient(135deg, #8b3200, #c06010);
            border: 1.5px solid rgba(240, 170, 60, 0.55);
            color: #fff0cc;
            font-family: 'Noto Serif TC', serif;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 0 18px rgba(160, 75, 10, 0.55);
            transition: box-shadow 0.2s, transform 0.2s;
        }

        #close-settings:hover {
            box-shadow: 0 0 28px rgba(220, 130, 20, 0.75);
            transform: scale(1.04);
        }

        /* ???? CLICK RIPPLE ???? */
        .ripple {
            position: absolute;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            background: rgba(220, 130, 20, 0.22);
            transform: scale(0);
            animation: rippleAnim 0.55s ease-out forwards;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes rippleAnim {
            to {
                transform: scale(5);
                opacity: 0;
            }
        }

        /* ???? NOTIFICATION TOAST ???? */
        #toast {
            position: absolute;
            top: 76px;
            left: 50%;
            transform: translateX(-50%) translateY(-90px);
            background: rgba(25, 8, 0, 0.95);
            border: 1.5px solid rgba(210, 130, 40, 0.55);
            color: #f0d898;
            font-size: 14px;
            padding: 10px 24px;
            border-radius: 22px;
            z-index: 60;
            transition: transform 0.3s ease;
            pointer-events: none;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* hide next-indicator & controls-bar during choices */
        #dialogue-area.choices-mode #next-indicator,
        #dialogue-area.choices-mode #controls-bar {
            display: none;
        }

        /* ???? MOBILE RESPONSIVE (iPhone Standard) ???? */
        @media (max-width: 430px) {
            #top-bar {
                top: 0px;
                left: 0px;
                right: 0px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            #game-title {
                font-size: 14px;
                padding: 4px 12px;
            }

            .top-btn {
                padding: 6px 14px;
                font-size: 13px;
            }

            #chapter-badge {
                top: auto;
                bottom: 240px;
                left: 10px;
                transform: scale(0.5);
                transform-origin: bottom left;
                flex-direction: row;
                gap: 8px;
            }

            .ch-label {
                font-size: 11px;
                padding: 3px 8px;
            }

            .ch-title {
                margin-top: 0;
                font-size: 14px;
                letter-spacing: 1px;
            }

            #quick-actions {
                top: auto;
                bottom: 240px;
                right: 10px;
                gap: 12px;
                transform: none;
            }

            .qa-btn {
                width: 38px;
                height: 38px;
                font-size: 18px;
            }

            #dialogue-area {
                bottom: 10px;
                left: 10px;
                right: 10px;
                width: auto;
            }

            #choice-panel {
                top: auto;
                bottom: 190px;
                left: 10px;
                right: 10px;
                width: auto;
                gap: 10px;
                transform: translateY(20px);
            }

            #choice-panel.visible {
                transform: translateY(0);
            }

            #dialogue-box {
                padding: 24px 18px 50px;
                min-height: 120px;
            }

            #dialogue-text {
                font-size: 17px;
                line-height: 1.6;
            }

            #speaker-plate {
                top: -18px;
                left: -10px;
                font-size: 16px;
                padding: 4px 16px;
            }

            .ctrl-btn {
                padding: 6px 14px;
                font-size: 13px;
            }

            .choice-label {
                font-size: 16px;
                background: rgba(20, 10, 0, 0.85);
                padding: 6px 16px;
                border-radius: 8px;
                display: inline-block;
                align-self: flex-start;
                border: 1px solid rgba(220, 140, 40, 0.4);
            }

            .choice-btn {
                padding: 12px 20px;
                font-size: 16px;
            }

            #history-panel {
                width: 90%;
                height: 85vh;
                padding: 20px 20px;
            }

            #history-panel h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }

            .history-text {
                font-size: 15px;
            }

            #settings-panel {
                width: 90%;
                max-height: 85vh;
                padding: 24px 20px;
                overflow-y: auto;
            }

            #settings-panel h2 {
                margin-bottom: 20px;
                font-size: 16px;
            }

            .setting-row {
                margin-bottom: 16px;
                flex-direction: row;
                align-items: center;
                gap: 12px;
            }

            .setting-slider {
                width: 150px;
            }

            .tog-btn {
                padding: 4px 10px;
                font-size: 12px;
            }

            #close-settings {
                margin-top: 16px;
                padding: 10px 36px;
                font-size: 14px;
            }

            #ooxx-grid {
                width: 200px;
                height: 200px;
            }

            .ooxx-cell {
                font-size: 38px;
                border-radius: 8px;
            }

            #ooxx-title {
                font-size: 20px;
                letter-spacing: 4px;
            }

            #ooxx-status {
                font-size: 15px;
            }

            #ooxx-result-text {
                font-size: 44px;
            }
        }

        /* ???? OOXX MINI-GAME ???? */
        #ooxx-screen {
            flex-direction: column;
            gap: 28px;
            background: radial-gradient(ellipse at center, #1a0a20 0%, #000000 100%);
        }

        #ooxx-title {
            font-family: 'Cinzel', serif;
            font-size: 26px;
            color: #f0d898;
            letter-spacing: 6px;
            text-shadow: 0 0 20px rgba(245, 160, 30, 0.8);
        }

        #ooxx-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            width: 270px;
            height: 270px;
        }

        .ooxx-cell {
            background: rgba(30, 15, 5, 0.75);
            border: 2px solid rgba(220, 140, 40, 0.40);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            cursor: pointer;
            transition: background 0.18s, border-color 0.18s, box-shadow 0.18s;
            backdrop-filter: blur(6px);
            user-select: none;
            -webkit-user-select: none;
        }

        .ooxx-cell:not(.taken):hover {
            background: rgba(180, 80, 10, 0.45);
            border-color: rgba(240, 170, 50, 0.85);
            box-shadow: 0 0 18px rgba(210, 120, 20, 0.50);
        }

        .ooxx-cell.taken {
            cursor: default;
        }

        .ooxx-cell.X {
            color: #ff6868;
            text-shadow: 0 0 10px rgba(255, 80, 80, 0.6);
        }

        .ooxx-cell.O {
            color: #68c8ff;
            text-shadow: 0 0 10px rgba(80, 180, 255, 0.6);
        }

        /* SVG symbols inside cells */
        .ooxx-cell svg {
            width: 58%;
            height: 58%;
            stroke: currentColor;
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            filter: drop-shadow(0 0 6px currentColor);
        }

        .ooxx-cell.win-line {
            background: rgba(220, 160, 20, 0.30);
            border-color: rgba(240, 200, 60, 0.90);
            box-shadow: 0 0 20px rgba(220, 160, 20, 0.70);
        }

        #ooxx-status {
            font-family: 'Noto Serif TC', serif;
            font-size: 17px;
            color: #d4a050;
            letter-spacing: 2px;
            text-align: center;
            min-height: 1.6em;
        }

        #ooxx-result {
            background: #000;
            pointer-events: none;
        }

        #ooxx-result:not(.hidden) {
            pointer-events: auto;
        }

        #ooxx-result-text {
            font-family: 'Noto Serif TC', serif;
            font-size: 56px;
            font-weight: bold;
            letter-spacing: 10px;
            opacity: 0;
            transition: opacity 0.45s ease;
        }

        #ooxx-result.show-text #ooxx-result-text {
            opacity: 1;
        }

        #ooxx-result-text.draw {
            color: #f0c040;
            text-shadow: 0 0 20px rgba(240, 180, 30, 0.9);
        }

        #ooxx-result-text.lose {
            color: #cc2222;
            text-shadow: 0 0 20px rgba(255, 40, 40, 0.9);
        }

        #ooxx-result-sub {
            font-family: 'Noto Serif TC', serif;
            font-size: 18px;
            color: #d4a050;
            letter-spacing: 4px;
            margin-top: 18px;
            opacity: 0;
            transition: opacity 0.45s ease 0.08s;
        }

        #ooxx-result.show-text #ooxx-result-sub {
            opacity: 1;
        }

        /* ???? SVG ICON HELPER ???? */
        .qa-svg {
            width: 1em;
            height: 1em;
            display: block;
            flex-shrink: 0;
        }

        .top-svg {
            width: 1.1em;
            height: 1.1em;
            vertical-align: middle;
            margin-right: 6px;
        }
    </style>
</head>

<body>

    <!-- Audio -->
    <audio id="bgm" src="UFP_120_Fmin_Kit_3_Nature.mp3" loop preload="auto"></audio>
    <audio id="sfx-death" src="TSP_NOISIA_fx_dist_fail_stab_mooi_toon.mp3" preload="auto"></audio>

    <div id="game-container">

        <!-- Background -->
        <div id="bg"></div>
        <div id="vignette"></div>
        <!-- BG.jpg splash: covers character during title, fades out on game start -->
        <div id="bg-splash"></div>
        <!-- OOXX transition curtain: fades to black before showing OOXX game -->
        <div id="ooxx-curtain"></div>

        <!-- Particles -->
        <div id="particles-container"></div>

        <!-- Character -->
        <div id="character-container">
            <img src="tail.png" id="char-tail" class="char-img active" alt="Tail" />
            <img src="body.png" id="char-body" class="char-img active" alt="Body" />
            <img src="no speak head.png" id="char-head-idle" class="char-img active" alt="Head Idle" />
            <img src="blink head.png" id="char-head-blink" class="char-img" alt="Head Blink" />
            <img src="speak head.png" id="char-head-speak" class="char-img" alt="Head Speak" />
            <img src="angry head.png" id="char-head-angry" class="char-img" alt="Head Angry" />
            <img src="happy head.png" id="char-head-happy" class="char-img" alt="Head Happy" />
        </div>
        <img src="money.png" id="money-popup" alt="Money Popup" />

        <!-- Top bar -->
        <div id="top-bar">
            <div id="game-title" class="lang-ui-gameTitle">????????????????????????????? ???????</div>
            <div class="top-btn-group">
                <button class="top-btn" id="lang-btn-gear" onclick="openSettings()">
                    <svg class="top-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>????????????
                </button>
            </div>
        </div>

        <!-- Chapter badge -->
        <div id="chapter-badge">
            <div class="ch-label">CHAPTER 01</div>
            <div class="ch-title" id="lang-ui-chapTitle">?????????????????????????</div>
        </div>

        <!-- Quick action buttons -->
        <div id="quick-actions">
            <div class="qa-btn" onclick="openSocial()"><img src="fox-face_1f98a.png" alt="Social Media"
                    style="width:36px;height:36px;object-fit:contain;display:block;">
                <span class="tooltip" id="lang-ui-social">?????????</span>
            </div>
            <div class="qa-btn" id="audio-toggle-btn" onclick="toggleAudioGlobal()">
                <svg class="qa-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 18V5l12-2v13" />
                    <circle cx="6" cy="18" r="3" />
                    <circle cx="18" cy="16" r="3" />
                </svg>
                <span class="tooltip" id="lang-ui-audio">??? (??</span>
            </div>
            <div class="qa-btn" onclick="openHistory()">
                <svg class="qa-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                    <line x1="8" y1="8" x2="16" y2="8" />
                    <line x1="8" y1="12" x2="16" y2="12" />
                    <line x1="8" y1="16" x2="12" y2="16" />
                </svg>
                <span class="tooltip" id="lang-ui-history">&#23565;&#35441;&#32000;&#37636;</span>
            </div>
            <div class="qa-btn" onclick="openMap()">
                <svg class="qa-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" />
                    <line x1="9" y1="3" x2="9" y2="18" />
                    <line x1="15" y1="6" x2="15" y2="21" />
                </svg>
                <span class="tooltip" id="lang-ui-map">???</span>
            </div>
        </div>

        <!-- Choice panel (left side) -->
        <div id="choice-panel">
            <div class="choice-label">?????????????????????????????</div>
            <button class="choice-btn" onclick="pickChoice(0)">
                <span class="choice-num">1</span>
                <span class="choice-text">??????????????????????UwU</span>
            </button>
            <button class="choice-btn" onclick="pickChoice(1)">
                <span class="choice-num">2</span>
                <span class="choice-text">&#25265;&#20303;&#28982;&#24460;&#25545;&#32922;&#23376;</span>
            </button>
            <button class="choice-btn" onclick="pickChoice(2)">
                <span class="choice-num">3</span>
                <span class="choice-text">????????</span>
            </button>
            <button class="choice-btn" onclick="pickChoice(3)">
                <span class="choice-num">4</span>
                <span class="choice-text">?????OOXX</span>
            </button>
        </div>

        <!-- Dialogue area -->
        <div id="dialogue-area">
            <div id="dialogue-box">
                <div id="speaker-plate">&#25552;&#29246;&#29392;</div>
                <div id="dialogue-text"></div>
                <div id="next-indicator">&#9662;</div>

                <!-- Bottom controls -->
                <div id="controls-bar">
                    <div class="ctrl-btn-group">
                        <button class="ctrl-btn" id="lang-btn-prev" onclick="prevLine()">?? ???????????</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast"></div>

                <!-- Settings overlay -->
        <div id="settings-overlay" onclick="handleSettingsClick(event)">
            <div id="settings-panel" onclick="event.stopPropagation()">
                <h2 id="lang-ui-settings-title">????????????????</h2>

                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-text-speed">??????????</span>
                    <input type="range" class="setting-slider" id="text-speed" min="1" max="10" value="3"
                        oninput="updateSlider(this)" style="--val:22.2%">
                </div>
                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-bgm">BGM ???</span>
                    <input type="range" class="setting-slider" id="bgm-vol" min="0" max="100" value="70"
                        oninput="updateSlider(this)" style="--val:70%">
                </div>
                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-sfx">??????</span>
                    <input type="range" class="setting-slider" id="sfx-vol" min="0" max="100" value="80"
                        oninput="updateSlider(this)" style="--val:80%">
                </div>
                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-voice">??????????</span>
                    <input type="range" class="setting-slider" id="voice-vol" min="0" max="100" value="90"
                        oninput="updateSlider(this)" style="--val:90%">
                </div>

                <div class="setting-divider"></div>

                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-fullscreen">&#20840;&#34722;&#24149;&#39023;&#31034;</span>
                    <div class="setting-toggle">
                        <button class="tog-btn" id="tog-fs-off" onclick="setToggle('fs','off')">??</button>
                        <button class="tog-btn on" id="tog-fs-on"
                            onclick="setToggle('fs','on');toggleFullscreen()">On</button>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label" id="lang-ui-lang">???????????</span>
                    <div class="setting-toggle">
                        <button class="tog-btn on" id="tog-lang-tw" onclick="setLanguage('tw')">&#32321;&#20013;</button>
                        <button class="tog-btn" id="tog-lang-jp" onclick="setLanguage('jp')">&#26085;&#26412;&#35486;</button>
                        <button class="tog-btn" id="tog-lang-en" onclick="setLanguage('en')">EN</button>
                    </div>
                </div>

                <div class="setting-divider"></div>

                <button id="close-settings" onclick="closeSettings()">???????????????</button>
            </div>
        </div>

    </div>
<!-- Title Screen -->
    <div id="title-screen" class="overlay-screen">

        <div class="setting-toggle" style="margin-bottom: 40px; transform: scale(1.2);">
            <button class="tog-btn on" id="title-lang-tw" onclick="setLanguage('tw')">&#32321;&#20013;</button>
            <button class="tog-btn" id="title-lang-jp" onclick="setLanguage('jp')">&#26085;&#26412;&#35486;</button>
            <button class="tog-btn" id="title-lang-en" onclick="setLanguage('en')">EN</button>
        </div>

        <div id="loading-container">
            <div id="loading-text">Loading Assets... 0%</div>
            <div id="loading-bar-bg">
                <div id="loading-bar-fill"></div>
            </div>
        </div>

        <button id="start-btn" onclick="startGame()" style="display: none; margin-top: 20px;">???</button>
    </div>

    <!-- Death Screen -->
    <div id="death-screen" class="overlay-screen hidden">
        <div id="death-text">??????????????</div>
    </div>

    <!-- To Be Continued Screen -->
    <div id="to-be-continued-screen" class="overlay-screen hidden">
        <div id="to-be-continued-text">&#24453;&#32396;...</div>
    </div>

    <!-- OOXX Game Screen -->
    <div id="ooxx-screen" class="overlay-screen hidden"></div>

    <!-- OOXX Result Screen -->
    <div id="ooxx-result" class="overlay-screen hidden">
        <div id="ooxx-result-text"></div>
        <div id="ooxx-result-sub"></div>
    </div>

    <!-- Map View -->
    <div id="map-overlay" class="overlay-screen hidden" onclick="closeMap()">
        <button id="close-map" onclick="closeMap(event)">?</button>
        <img src="ad630f06-22cd-45a6-842b-1e8e78c36a61.jpg" alt="Map" onclick="event.stopPropagation()">
    </div>

    <!-- History Panel -->
    <div id="history-overlay" class="overlay-screen hidden" onclick="handleHistoryClick(event)">
        <div id="history-panel" onclick="event.stopPropagation()">
            <h2 id="lang-ui-hist-title">?? ??????????</h2>
            <div id="history-list">
                <!-- Records injected here -->
            </div>
            <button id="close-history" onclick="closeHistory()">???</button>
        </div>
    </div>

    <script type="text/plain" id="legacy-inline-script">
        // ???? Audio Engine ????????????????????????????????????????????????????????????????????????????????????????????????????
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioMuted = false;

        function toggleAudioGlobal() {
            audioMuted = !audioMuted;
            const btn = document.getElementById('audio-toggle-btn');

            if (audioMuted) {
                document.getElementById('bgm').pause();
                btn.innerHTML = `<svg class="qa-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/><line x1="2" y1="2" x2="22" y2="22"/></svg><span class="tooltip" id="lang-ui-audio">${l10n[currentLang].ui.audioOff}</span>`;
            } else {
                ensureAudio();
                document.getElementById('bgm').play().catch(() => { });
                btn.innerHTML = `<svg class="qa-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg><span class="tooltip" id="lang-ui-audio">${l10n[currentLang].ui.audioOn}</span>`;
            }
        }

        // Tiny synth tap: short band-pass burst ??typewriter feel
        function playTap() {
            if (audioMuted) return;
            const vol = parseFloat(document.getElementById('sfx-vol').value) / 100;
            if (vol === 0) return;
            const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.04, audioCtx.sampleRate);
            const data = buf.getChannelData(0);
            for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (data.length * 0.18));
            const src = audioCtx.createBufferSource();
            src.buffer = buf;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 3200;
            filter.Q.value = 1.2;
            const gain = audioCtx.createGain();
            gain.gain.value = vol * 0.13;
            src.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            src.start();
        }

        // Soft hover blip: short sine fade
        function playHover() {
            if (audioMuted) return;
            const vol = parseFloat(document.getElementById('sfx-vol').value) / 100;
            if (vol === 0) return;
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(900, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(700, audioCtx.currentTime + 0.06);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(vol * 0.06, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.09);
        }

        // Click confirm tone: two-tone short blip
        function playClick() {
            if (audioMuted) return;
            const vol = parseFloat(document.getElementById('sfx-vol').value) / 100;
            if (vol === 0) return;
            [520, 760].forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = freq;
                const gain = audioCtx.createGain();
                const t = audioCtx.currentTime + i * 0.05;
                gain.gain.setValueAtTime(vol * 0.08, t);
                gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.09);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + 0.1);
            });
        }

        // Resume AudioContext on first interaction (browser policy)
        function ensureAudio() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // BGM
        const bgmEl = document.getElementById('bgm');
        function startBGM() {
            if (audioMuted) return;
            ensureAudio();
            const vol = parseFloat(document.getElementById('bgm-vol').value) / 100;
            bgmEl.volume = vol;
            bgmEl.play().catch(() => { });
        }

        // Wire hover/click SFX to all buttons and qa-btns after DOM ready
        function wireSfx() {
            document.querySelectorAll('button, .qa-btn, .choice-btn').forEach(el => {
                el.addEventListener('mouseenter', () => { ensureAudio(); playHover(); });
                el.addEventListener('click', () => { ensureAudio(); playClick(); });
            });
        }

        // ???? Particles Generation ????????????????????????????????????????????????????????????????????????????????????
        function createParticles() {
            const container = document.getElementById('particles-container');
            const particleCount = 45; // Amount of floating particles

            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.className = 'particle';

                // Random size between 2px and 4px
                const size = Math.random() * 2 + 2;
                p.style.width = `${size}px`;
                p.style.height = `${size}px`;

                // Random position
                p.style.left = `${Math.random() * 100}%`;
                p.style.top = `${Math.random() * 100}%`;

                // Random animation delay and duration
                const duration = Math.random() * 8 + 6; // 6s to 14s
                const delay = Math.random() * 14;

                p.style.animationDuration = `${duration}s`;
                p.style.animationDelay = `-${delay}s`;

                // Random horizontal drift
                const xDrift = (Math.random() - 0.5) * 80;
                p.style.setProperty('--x-drift', `${xDrift}px`);

                container.appendChild(p);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            wireSfx();
            createParticles();
            startAssetLoader();
        });

        // Also start BGM on first click anywhere
        document.addEventListener('click', startBGM, { once: true });

        // ???? Dialogue Script & L10n ????????????????????????????????????????????????????????????????????????
        let currentLang = 'tw';

        const l10n = {
            tw: {
                startBtn: '???',
                deathText: '??????????????,
                speaker: '??????,
                lines: [
                    '???????????????????????????',
                    '?????????????????????????????????..',
                    '????????????????????????????????????!',
                    '???????...?????!',
                    '??..????????????????'
                ],
                choiceTitle: '?????????????????????????????,
                choices: [
                    '??????????????????????UwU',
                    '????????,
                    '????????',
                    '???OOXX'
                ],
                responses: [
                    '????!!(??????',
                    '??????..??????????',
                    '????! ????!!!',
                    '???????????
                ],
                ui: {
                    docTitle: '????????????????????????????? - ?????, gameTitle: '????????????????????????????? ???????,
                    save: '?????????', load: '??????, autoBtn: '???', skip: '???????', gearBtn: '??????????????', chapTitle: '?????????????????????????,
                    cg: 'CG ??????????', audioOn: '??? (??', audioOff: '??? (??', history: '??????????, map: '???',
                    prev: '?? ???????????, histBtn: '?????????,
                    histTitle: '?? ??????????, closeHist: '???',
                    settingTitle: '??????????????????', textSpeed: '??????????, bgm: 'BGM ???', sfx: '??????', voice: '??????????',
                    fullScreen: '?????????????????, lang: '???????????', closeSet: '???????????????',
                    on: '???', off: '???', tw: '?????????????????, jp: '????????????????????, en: 'EN',
                    socialPrompt: '???????????????????? TERU FOX ???????????????', social: '?????????',
                    toastSave: '?? ???????, toastLoad: '?? ????????????...', toastSkip: '???????????, toastAutoOn: '????????? ON',
                    toastAutoOff: '????????? OFF', toastContinue: '???????????..', noHistory: '?????????????..',
                    ooxxTitle: 'OOXX ????', ooxxYourTurn: '??????? (O)', ooxxAiTurn: '????????...',
                    ooxxDraw: '???????', ooxxLose: '???????????, ooxxTapReturn: '????????????????????
                }
            },
            en: {
                startBtn: 'Start',
                deathText: 'You were bitten to death',
                speaker: '??????,
                lines: [
                    'Are you seriously not some weird furry?',
                    'Who asks to go home with me right after meeting...',
                    'And absolutely NO touching my tail!',
                    'If you touch it, I will... bite you!!',
                    'W-What are you trying to do?'
                ],
                choiceTitle: '??Choose your action ??,
                choices: [
                    'Pounce and touch the tail UwU',
                    'Hug and rub the belly',
                    'Touch the OO',
                    'I want to OOXX with you'
                ],
                responses: [
                    'No!! (bite bite bite)',
                    'W..What?',
                    'No! Pervert!!!',
                    'Help meee'
                ],
                ui: {
                    docTitle: "Da'an Forest Park - Meadow", gameTitle: "Da'an Forest Park ??Meadow",
                    save: 'Save', load: 'Load', skip: 'Skip', gearBtn: '??Settings', chapTitle: 'First Encounter',
                    audioOn: 'Music (On)', audioOff: 'Music (Off)', history: 'Log', map: 'Map',
                    prev: '?? Prev', histBtn: 'Log',
                    histTitle: '?? Dialogue Log', closeHist: 'Close',
                    settingTitle: '??Settings', textSpeed: 'Text Speed', bgm: 'BGM Vol', sfx: 'SFX Vol', voice: 'Voice Vol',
                    fullScreen: 'Fullscreen', lang: 'Language', closeSet: 'Close Settings',
                    on: 'On', off: 'Off', tw: 'TW', jp: 'JP', en: 'EN',
                    socialPrompt: "Would you like to visit TERU FOX's social media page?", social: 'Social',
                    toastSave: '?? Saved', toastLoad: '?? Loading...', toastSkip: '??Skipping', toastAutoOn: '??Auto Play ON',
                    toastAutoOff: '??Auto Play OFF', toastContinue: '??Story continues...', noHistory: 'No history...',
                    ooxxTitle: 'OOXX Game', ooxxYourTurn: 'Your turn (O)', ooxxAiTurn: '??????is thinking...',
                    ooxxDraw: 'Draw', ooxxLose: 'You Lost', ooxxTapReturn: 'Tap anywhere to return'
                }
            },
            jp: {
                startBtn: '?????????',
                deathText: '??????????????????????????',
                speaker: '??????,
                lines: [
                    '????????????????????????????????????????????????????????????????????????????????????????????????????????,
                    '??????????????????????????????????????????????????????????????????????????????????????????',
                    '??????????????????????????????????????????????????????????????????????????????????????',
                    '?????????????????????????????????????????????????????????????????????????????????????,
                    '?????????????????????????????????????????????????????????????????????????'
                ],
                choiceTitle: '????????????,
                choices: [
                    '?????????????????????????? UwU',
                    '?????????????????????,
                    'OO???????,
                    '???????????????????????????????????????
                ],
                responses: [
                    '????! (????????',
                    '?????..?????',
                    '??????????!!!',
                    '?????????'
                ],
                ui: {
                    docTitle: '????????????????????????????? - ???', gameTitle: '????????????????????????????? ?????',
                    save: '???????, load: '??????, skip: '?????????', gearBtn: '??????????????', chapTitle: '????????????,
                    audioOn: '????????(????)', audioOff: '????????(???)', history: '?????????, map: '?????,
                    prev: '?? ???', histBtn: '?????????,
                    histTitle: '?? ???????????????????, closeHist: '?????,
                    settingTitle: '??????????????', textSpeed: '??????????????, bgm: 'BGM???', sfx: 'SE???', voice: '??????????????????????,
                    fullScreen: '???????????????, lang: '????????????, closeSet: '??????????????????',
                    on: '????', off: '???', tw: 'TW', jp: 'JP', en: 'EN',
                    socialPrompt: 'TERU FOX??????????????????????????????????', social: '????????????????Ⅹ????????????????,
                    toastSave: '?? ??????????, toastLoad: '?? ????????...', toastSkip: '??????????????????, toastAutoOn: '??????????,
                    toastAutoOff: '???????????, toastContinue: '??????????..', noHistory: '???????????????????...',
                    ooxxTitle: 'OOXX??????, ooxxYourTurn: '???????????????????????????????(O)', ooxxAiTurn: '??????????????????????????????...',
                    ooxxDraw: '???????', ooxxLose: '????????????????????????????', ooxxTapReturn: '?????????????
                }
            }
        };

        const script = [
            { type: 'line' },
            { type: 'line' },
            { type: 'line' },
            { type: 'line' },
            { type: 'line' },
            { type: 'choice' },
        ];

        let lineIndex = 0;
        let charIndex = 0;
        let typeTimer = null;
        let isTyping = false;
        let autoPlay = false;
        let textSpeedMs = 45;
        let inChoiceMode = false;

        // Character Animation State
        let isSpeaking = false;
        let isAngry = false;
        let blinkTimeout = null;
        let speakInterval = null;

        const charIdle = document.getElementById('char-idle');
        const charBlink = document.getElementById('char-blink');
        const charSpeak = document.getElementById('char-speak');
        const charAngry = document.getElementById('char-angry');

        const dialogueText = document.getElementById('dialogue-text');
        const speakerPlate = document.getElementById('speaker-plate');
        const dialogueArea = document.getElementById('dialogue-area');
        const choicePanel = document.getElementById('choice-panel');
        // const totalDots = script.length; (Removed)

        function setCharState(state) {
            charIdle.classList.remove('active');
            charBlink.classList.remove('active');
            charSpeak.classList.remove('active');
            if (charAngry) charAngry.classList.remove('active');

            if (isAngry) {
                if (charAngry) charAngry.classList.add('active');
                return;
            }

            if (state === 'idle') charIdle.classList.add('active');
            else if (state === 'blink') charBlink.classList.add('active');
            else if (state === 'speak') charSpeak.classList.add('active');
            else if (state === 'angry') { if (charAngry) charAngry.classList.add('active'); }
        }

        function scheduleNextBlink() {
            if (isSpeaking) return;
            // Human-like blink interval: 2s to 6s
            const nextBlinkTime = 2000 + Math.random() * 4000;
            blinkTimeout = setTimeout(() => {
                if (isSpeaking) return;
                setCharState('blink');
                setTimeout(() => {
                    if (isSpeaking) return;
                    setCharState('idle');
                    // 20% chance for a quick double blink
                    if (Math.random() < 0.2) {
                        setTimeout(() => {
                            if (isSpeaking) return;
                            setCharState('blink');
                            setTimeout(() => {
                                if (isSpeaking) return;
                                setCharState('idle');
                                scheduleNextBlink();
                            }, 100);
                        }, 100);
                    } else {
                        scheduleNextBlink();
                    }
                }, 100); // 100ms blink duration
            }, nextBlinkTime);
        }

        function startSpeakingAnimation() {
            if (speakInterval) clearInterval(speakInterval);
            let mouthOpen = true;
            setCharState('speak'); // start with mouth open
            speakInterval = setInterval(() => {
                mouthOpen = !mouthOpen;
                setCharState(mouthOpen ? 'speak' : 'idle');
            }, 120); // Fast toggle every 120ms
        }

        function stopSpeakingAnimation() {
            if (speakInterval) {
                clearInterval(speakInterval);
                speakInterval = null;
            }
        }

        function setTyping(flag) {
            isTyping = flag;
            dialogueText.classList.toggle('typing', flag);

            isSpeaking = flag;

            if (isAngry) {
                stopSpeakingAnimation();
                clearTimeout(blinkTimeout);
                setCharState('angry');
                return;
            }

            if (isSpeaking) {
                clearTimeout(blinkTimeout); // Stop blinking when starting to type
                startSpeakingAnimation();
            } else {
                stopSpeakingAnimation();
                setCharState('idle');
                scheduleNextBlink(); // Resume blinking when done typing
            }
        }

        function renderLine(idx) {
            const entry = script[idx];
            const t = l10n[currentLang];

            if (entry.type === 'choice') {
                inChoiceMode = true;
                dialogueArea.classList.add('choices-mode');
                choicePanel.classList.add('visible');
                document.getElementById('chapter-badge').style.opacity = '0';
                document.getElementById('chapter-badge').style.pointerEvents = 'none';

                // Update choice labels
                document.querySelector('.choice-label').textContent = t.choiceTitle;
                const choiceBtns = document.querySelectorAll('.choice-btn .choice-text');
                t.choices.forEach((text, i) => choiceBtns[i].textContent = text);

                return;
            }

            inChoiceMode = false;
            dialogueArea.classList.remove('choices-mode');
            choicePanel.classList.remove('visible');
            document.getElementById('chapter-badge').style.opacity = '1';
            document.getElementById('chapter-badge').style.pointerEvents = 'auto';
            speakerPlate.textContent = t.speaker;
            dialogueText.textContent = '';
            charIndex = 0;
            setTyping(true);
            clearInterval(typeTimer);

            const lineText = t.lines[idx];

            typeTimer = setInterval(() => {
                if (charIndex < lineText.length) {
                    dialogueText.textContent += lineText[charIndex++];
                    playTap();
                } else {
                    clearInterval(typeTimer);
                    setTyping(false);
                    // Add to history once complete typing
                    if (!dialogueHistory.some(r => r.text === lineText && (!r.isChoice))) {
                        dialogueHistory.push({ speaker: t.speaker, text: lineText, isChoice: false });
                    }
                    if (autoPlay && idx < script.length - 1) setTimeout(nextLine, 1800);
                }
            }, textSpeedMs);
        }

        // function updateDots(idx) { ... } (Removed)

        function nextLine() {
            if (inChoiceMode) return;
            if (isTyping) {
                clearInterval(typeTimer);
                setTyping(false);
                // Use localized text, not the undefined script[].text
                const lineText = l10n[currentLang].lines[lineIndex];
                if (lineText) dialogueText.textContent = lineText;
                return;
            }
            if (lineIndex < script.length - 1) {
                lineIndex++;
                renderLine(lineIndex);
            } else {
                showToast(l10n[currentLang].ui.toastContinue);
            }
        }

        function prevLine() {
            if (lineIndex > 0) {
                lineIndex--;
                renderLine(lineIndex);
            }
        }

        let isDeathSequence = false;

        function pickChoice(idx) {
            inChoiceMode = false;
            dialogueArea.classList.remove('choices-mode');
            choicePanel.classList.remove('visible');
            document.getElementById('chapter-badge').style.opacity = '1';
            document.getElementById('chapter-badge').style.pointerEvents = 'auto';

            // Choice 3 ??launch OOXX minigame instead of normal response
            if (idx === 3) {
                startOOXX();
                return;
            }

            isAngry = true;
            setCharState('angry');

            const t = l10n[currentLang];
            const responseText = t.responses[idx];

            // Add user choice to history
            dialogueHistory.push({ speaker: '', text: t.choices[idx], isChoice: true });

            speakerPlate.textContent = t.speaker;
            dialogueText.textContent = '';
            charIndex = 0;
            setTyping(true);
            clearInterval(typeTimer);

            typeTimer = setInterval(() => {
                if (charIndex < responseText.length) {
                    dialogueText.textContent += responseText[charIndex++];
                    playTap();
                } else {
                    clearInterval(typeTimer);
                    setTyping(false);
                    dialogueHistory.push({ speaker: t.speaker, text: responseText, isChoice: false });
                    isDeathSequence = true;
                    setTimeout(triggerDeath, 1000); // 1s pause after text before death screen
                }
            }, textSpeedMs);
        }

        // ???? OOXX MINI-GAME ????????????????????????????????????????????????????????????????????????????????????????????
        const OOXX_AI = 'X', OOXX_HU = 'O';
        let ooxxBoard = [], ooxxLocked = false;

        function checkOOXX(b) {
            const lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            for (const ln of lines) {
                const [a, c, d] = ln;
                if (b[a] && b[a] === b[c] && b[a] === b[d]) return { winner: b[a], line: ln };
            }
            return null;
        }

        function minimax(b, isMax) {
            const r = checkOOXX(b);
            if (r) return r.winner === OOXX_AI ? 10 : -10;
            if (b.every(c => c)) return 0;
            let best = isMax ? -Infinity : Infinity;
            for (let i = 0; i < 9; i++) {
                if (!b[i]) {
                    b[i] = isMax ? OOXX_AI : OOXX_HU;
                    const val = minimax(b, !isMax);
                    b[i] = '';
                    best = isMax ? Math.max(best, val) : Math.min(best, val);
                }
            }
            return best;
        }

        function getBestOOXX(b) {
            let bestVal = -Infinity, bestMove = -1;
            for (let i = 0; i < 9; i++) {
                if (!b[i]) {
                    b[i] = OOXX_AI;
                    const val = minimax(b, false);
                    b[i] = '';
                    if (val > bestVal) { bestVal = val; bestMove = i; }
                }
            }
            return bestMove;
        }

        const OOXX_SVG = {
            X: `<svg viewBox="0 0 40 40"><line x1="10" y1="10" x2="30" y2="30"/><line x1="30" y1="10" x2="10" y2="30"/></svg>`,
            O: `<svg viewBox="0 0 40 40"><circle cx="20" cy="20" r="12"/></svg>`
        };

        function renderOOXX(highlightLine) {
            document.querySelectorAll('.ooxx-cell').forEach((cell, i) => {
                cell.className = 'ooxx-cell';
                cell.innerHTML = ooxxBoard[i] ? OOXX_SVG[ooxxBoard[i]] : '';
                if (ooxxBoard[i]) cell.classList.add('taken', ooxxBoard[i]);
                if (highlightLine && highlightLine.includes(i)) cell.classList.add('win-line');
            });
        }

        function ooxxSetStatus(key) {
            const el = document.getElementById('ooxx-status');
            if (el) el.textContent = l10n[currentLang].ui[key] || key;
        }

        const OVERLAY_FADE_MS = 1000;
        const OOXX_ENTRY_TRANSITION = { fadeInMs: 1200, holdMs: 1800, fadeOutMs: 1200 };
        const OOXX_RESULT_TRANSITION = { fadeInMs: 900, holdMs: 700, fadeOutMs: 900 };
        const OOXX_TRANSITION_CANCELLED = 'OOXX_TRANSITION_CANCELLED';
        let ooxxTransitionLock = false;
        let ooxxTransitionToken = 0;

        function waitMs(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function logOOXXTransition(token, phase, detail) {
            const ts = new Date().toISOString();
            const msg = detail ? `${phase} | ${detail}` : phase;
            console.log(`[OOXX][${ts}][token:${token}] ${msg}`);
        }

        function beginOOXXTransition(label) {
            ooxxTransitionLock = true;
            ooxxTransitionToken += 1;
            const token = ooxxTransitionToken;
            logOOXXTransition(token, `${label} begin`);
            return token;
        }

        function endOOXXTransition(token, label) {
            if (token !== ooxxTransitionToken) return;
            ooxxTransitionLock = false;
            logOOXXTransition(token, `${label} end`);
        }

        function cancelOOXXTransitions(reason) {
            ooxxTransitionToken += 1;
            ooxxTransitionLock = false;
            setOOXXCurtainInstant(false);
            logOOXXTransition(ooxxTransitionToken, 'cancel', reason || 'manual reset');
        }

        function ensureOOXXToken(token) {
            if (token !== ooxxTransitionToken) {
                throw new Error(OOXX_TRANSITION_CANCELLED);
            }
        }

        function setOOXXCurtainInstant(visible) {
            const curtain = document.getElementById('ooxx-curtain');
            curtain.classList.remove('dark');
            curtain.style.transition = 'none';
            curtain.style.opacity = visible ? '1' : '0';
            curtain.style.pointerEvents = visible ? 'all' : 'none';
            void curtain.offsetWidth;
            curtain.style.transition = '';
        }

        function animateOOXXCurtainTo({ token, visible, durationMs, phase }) {
            const curtain = document.getElementById('ooxx-curtain');
            const targetOpacity = visible ? '1' : '0';
            const fromOpacity = visible ? '0' : '1';

            return new Promise(resolve => {
                let settled = false;
                const settle = (reason) => {
                    if (settled) return;
                    settled = true;
                    curtain.removeEventListener('transitionend', onEnd);
                    curtain.style.pointerEvents = visible ? 'all' : 'none';
                    logOOXXTransition(token, `${phase} end`, `reason=${reason}`);
                    resolve();
                };
                const onEnd = (e) => {
                    if (e.target === curtain && e.propertyName === 'opacity') settle('transitionend');
                };

                logOOXXTransition(token, `${phase} start`, `duration=${durationMs}ms`);
                curtain.style.pointerEvents = 'all';
                curtain.classList.remove('dark');

                const currentOpacity = parseFloat(getComputedStyle(curtain).opacity);
                if (Number.isNaN(currentOpacity) || Math.abs(currentOpacity - parseFloat(targetOpacity)) < 0.01 || durationMs <= 0) {
                    curtain.style.transition = 'none';
                    curtain.style.opacity = targetOpacity;
                    curtain.style.pointerEvents = visible ? 'all' : 'none';
                    logOOXXTransition(token, `${phase} end`, 'reason=instant');
                    resolve();
                    return;
                }

                if (Math.abs(currentOpacity - parseFloat(fromOpacity)) > 0.01) {
                    curtain.style.transition = 'none';
                    curtain.style.opacity = fromOpacity;
                    void curtain.offsetWidth;
                }

                curtain.addEventListener('transitionend', onEnd);
                curtain.style.transition = `opacity ${durationMs}ms ease`;
                requestAnimationFrame(() => {
                    curtain.style.opacity = targetOpacity;
                });

                setTimeout(() => settle('timeout'), durationMs + 180);
            });
        }

        async function runCurtainTransition({ fadeInMs, holdMs, fadeOutMs }, { token, label, onBlack } = {}) {
            const activeToken = token || ooxxTransitionToken;
            const tag = label || 'transition';

            ensureOOXXToken(activeToken);
            await animateOOXXCurtainTo({
                token: activeToken,
                visible: true,
                durationMs: fadeInMs,
                phase: `${tag}: fade-in`
            });
            ensureOOXXToken(activeToken);

            if (typeof onBlack === 'function') {
                logOOXXTransition(activeToken, `${tag}: on-black start`);
                await onBlack();
                logOOXXTransition(activeToken, `${tag}: on-black end`);
                ensureOOXXToken(activeToken);
            }

            logOOXXTransition(activeToken, `${tag}: hold start`, `${holdMs}ms`);
            await waitMs(holdMs);
            ensureOOXXToken(activeToken);
            logOOXXTransition(activeToken, `${tag}: hold end`);

            await animateOOXXCurtainTo({
                token: activeToken,
                visible: false,
                durationMs: fadeOutMs,
                phase: `${tag}: fade-out`
            });
            ensureOOXXToken(activeToken);
        }

        function endOOXX(winnerMark, line) {
            ooxxLocked = true;
            renderOOXX(line);
            const ui = l10n[currentLang].ui;
            const isDraw = !winnerMark;
            const resultText = isDraw ? ui.ooxxDraw : ui.ooxxLose;
            const cls = isDraw ? 'draw' : 'lose';
            const subText = isDraw ? '' : (
                currentLang === 'jp' ? '?????????????????????????????????' :
                    currentLang === 'en' ? 'Win and you\'d get a special CG...' :
                        '?????????????
            );

            setTimeout(async () => {
                if (ooxxTransitionLock) return;
                const token = beginOOXXTransition('result');
                try {
                    const screen = document.getElementById('ooxx-screen');
                    stopOOXXAmbience();

                    // Stop BGM
                    document.getElementById('bgm').pause();

                    // Play death sound effect on a loss (same as triggerDeath)
                    if (!isDraw && !audioMuted) {
                        const deathSfx = document.getElementById('sfx-death');
                        deathSfx.volume = parseFloat(document.getElementById('sfx-vol').value) / 100;
                        deathSfx.currentTime = 0;
                        deathSfx.play().catch(() => { });
                    }

                    const resultEl = document.getElementById('ooxx-result');
                    const textEl = document.getElementById('ooxx-result-text');
                    const subEl = document.getElementById('ooxx-result-sub');
                    textEl.textContent = resultText;
                    textEl.className = cls;
                    subEl.textContent = subText;

                    await runCurtainTransition(OOXX_RESULT_TRANSITION, {
                        token,
                        label: 'result',
                        onBlack: async () => {
                            screen.style.transition = 'none';
                            screen.classList.add('hidden');
                            void screen.offsetWidth;
                            screen.style.transition = '';

                            resultEl.style.transition = 'none';
                            resultEl.classList.remove('hidden');
                            resultEl.classList.remove('show-text');
                            void resultEl.offsetWidth;
                            resultEl.style.transition = '';
                        }
                    });

                    setTimeout(() => {
                        if (token !== ooxxTransitionToken) return;
                        resultEl.classList.add('show-text');
                    }, 120);

                    resultEl.addEventListener('click', function once() {
                        resultEl.removeEventListener('click', once);
                        resultEl.classList.remove('show-text'); // reset for next time
                        // Return to title and restart BGM
                        returnToTitle(resultEl, () => {
                            lineIndex = 0;
                            document.getElementById('bgm').currentTime = 0;
                            startBGM();
                        });
                    });
                } catch (err) {
                    if (!err || err.message !== OOXX_TRANSITION_CANCELLED) {
                        console.error('OOXX result transition error:', err);
                    }
                } finally {
                    endOOXXTransition(token, 'result');
                }
            }, 900);
        }

        function aiOOXXMove() {
            const move = getBestOOXX(ooxxBoard);
            if (move === -1) return;
            ooxxBoard[move] = OOXX_AI;
            playOOXXPlace(true); // AI piece sound
            const res = checkOOXX(ooxxBoard);
            if (res || ooxxBoard.every(c => c)) {
                endOOXX(res ? res.winner : null, res ? res.line : null);
            } else {
                renderOOXX();
                ooxxLocked = false;
                ooxxSetStatus('ooxxYourTurn');
            }
        }

        async function startOOXX() {
            if (ooxxTransitionLock) return;
            const token = beginOOXXTransition('entry');

            try {
                ooxxBoard = Array(9).fill('');
                ooxxLocked = true;
                const ui = l10n[currentLang].ui;
                const screen = document.getElementById('ooxx-screen');
                const resultEl = document.getElementById('ooxx-result');

                await runCurtainTransition(OOXX_ENTRY_TRANSITION, {
                    token,
                    label: 'entry',
                    onBlack: async () => {
                        // Build OOXX while fully black.
                        screen.innerHTML = `
                    <div id="ooxx-title">${ui.ooxxTitle}</div>
                    <div id="ooxx-grid">${Array.from({ length: 9 }, (_, i) => `<div class="ooxx-cell" data-i="${i}"></div>`).join('')}</div>
                    <div id="ooxx-status">${ui.ooxxAiTurn}</div>`;
                        screen.querySelectorAll('.ooxx-cell').forEach(cell => {
                            cell.addEventListener('click', () => {
                                const i = +cell.dataset.i;
                                if (ooxxLocked || ooxxBoard[i]) return;
                                ooxxLocked = true;
                                ooxxBoard[i] = OOXX_HU;
                                playOOXXPlace(false);
                                const res = checkOOXX(ooxxBoard);
                                if (res || ooxxBoard.every(c => c)) {
                                    endOOXX(res ? res.winner : null, res ? res.line : null);
                                    return;
                                }
                                renderOOXX();
                                ooxxSetStatus('ooxxAiTurn');
                                setTimeout(aiOOXXMove, 500);
                            });
                        });

                        // Show OOXX instantly behind black curtain.
                        screen.style.transition = 'none';
                        screen.classList.remove('hidden');
                        void screen.offsetWidth;
                        screen.style.transition = '';
                        resultEl.classList.add('hidden');
                        resultEl.classList.remove('show-text');
                    }
                });

                setTimeout(() => {
                    if (token !== ooxxTransitionToken) return;
                    aiOOXXMove();
                }, 90);
            } catch (err) {
                if (!err || err.message !== OOXX_TRANSITION_CANCELLED) {
                    console.error('OOXX entry transition error:', err);
                }
            } finally {
                endOOXXTransition(token, 'entry');
            }
        }

        // ???? OOXX PIECE PLACEMENT SOUND ????????????????????????????????????????????????????????????
        // Short crisp tone, similar in character to playTap() but deeper
        function playOOXXPlace(isAI) {
            if (audioMuted) return;
            try {
                const vol = parseFloat(document.getElementById('sfx-vol').value) / 100;
                if (vol === 0) return;
                const freq = isAI ? 300 : 500; // AI(X) = lower thud, Player(O) = higher click
                const osc = audioCtx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(freq * 0.80, audioCtx.currentTime + 0.07);
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(vol * 0.14, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.09);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.10);
            } catch (e) { }
        }

        // Kept as no-ops so existing call sites don't break
        function startOOXXAmbience() { }
        function stopOOXXAmbience() { }

        function triggerDeath() {
            const deathScreen = document.getElementById('death-screen');
            deathScreen.classList.remove('hidden');

            // Stop BGM and play death sound
            document.getElementById('bgm').pause();
            if (!audioMuted) {
                const deathSfx = document.getElementById('sfx-death');
                deathSfx.volume = parseFloat(document.getElementById('sfx-vol').value) / 100;
                deathSfx.currentTime = 0; // ensure it plays from beginning
                deathSfx.play().catch(() => { });
            }

            // Show text after screen turns black
            setTimeout(() => {
                deathScreen.classList.add('show-text');

                // Return to title after keeping death screen for a few seconds
                setTimeout(() => {
                    deathScreen.classList.remove('show-text');
                    returnToTitle(deathScreen);
                }, 4000);
            }, 1000);
        }

        // Click anywhere to advance
        document.getElementById('game-container').addEventListener('click', function (e) {
            if (e.target.closest('button, .qa-btn, #settings-overlay, #top-bar, #choice-panel, #ooxx-result, #ooxx-screen')) return;
            const r = document.createElement('div');
            r.className = 'ripple';
            const rect = this.getBoundingClientRect();
            r.style.left = (e.clientX - rect.left - 25) + 'px';
            r.style.top = (e.clientY - rect.top - 25) + 'px';
            this.appendChild(r);
            setTimeout(() => r.remove(), 560);

            if (!isDeathSequence && !isTyping) {
                nextLine();
            }
        });

        // Trigger death shortcut if clicking anywhere on the black death screen overlay (to force show text)
        document.getElementById('death-screen').addEventListener('click', function (e) {
            // If we've started the sequence but the text hasn't shown up yet, fast-forward it
            this.classList.add('show-text');
        });

        // ???? Settings ????????????????????????????????????????????????????????????????????????????????????????????????????????????
        const overlay = document.getElementById('settings-overlay');
        function openSettings() { overlay.style.display = 'flex'; setTimeout(() => overlay.classList.add('open'), 10); }
        function closeSettings() { overlay.classList.remove('open'); setTimeout(() => overlay.style.display = 'none', 300); }
        function handleSettingsClick(e) { if (e.target === overlay) closeSettings(); }

        function setLanguage(lang) {
            currentLang = lang;
            ['tw', 'jp', 'en'].forEach(l => {
                document.getElementById('tog-lang-' + l).classList.toggle('on', l === lang);
                const titleBtn = document.getElementById('title-lang-' + l);
                if (titleBtn) titleBtn.classList.toggle('on', l === lang);
            });
            updateUIText();

            // Re-render current line immediately to reflect language change if not in transition
            if (!isDeathSequence && !isTyping && !inChoiceMode && script[lineIndex]) {
                const t = l10n[lang];
                speakerPlate.textContent = t.speaker;
                dialogueText.textContent = t.lines[lineIndex];
            } else if (inChoiceMode) {
                const t = l10n[lang];
                document.querySelector('.choice-label').textContent = t.choiceTitle;
                const choiceBtns = document.querySelectorAll('.choice-btn .choice-text');
                t.choices.forEach((text, i) => choiceBtns[i].textContent = text);
            }
        }

        function updateUIText() {
            const t = l10n[currentLang];
            const ui = t.ui;

            document.getElementById('lang-ui-docTitle').textContent = ui.docTitle;
            document.querySelector('.lang-ui-gameTitle').textContent = ui.gameTitle;
            document.getElementById('lang-btn-gear').textContent = ui.gearBtn;
            document.getElementById('lang-ui-chapTitle').textContent = ui.chapTitle;

            document.getElementById('start-btn').textContent = t.startBtn;
            document.getElementById('death-text').textContent = t.deathText;

            document.getElementById('lang-ui-social').textContent = ui.social;
            document.getElementById('lang-ui-audio').textContent = audioMuted ? ui.audioOff : ui.audioOn;
            <span class="tooltip" id="lang-ui-history">&#23565;&#35441;&#32000;&#37636;</span>
            document.getElementById('lang-ui-map').textContent = ui.map;

            document.getElementById('lang-btn-prev').textContent = ui.prev;
            document.getElementById('lang-btn-hist').textContent = ui.histBtn;

            document.getElementById('lang-ui-hist-title').textContent = ui.histTitle;
            document.getElementById('close-history').textContent = ui.closeHist;

            document.getElementById('lang-ui-settings-title').textContent = ui.settingTitle;
            document.getElementById('lang-ui-text-speed').textContent = ui.textSpeed;
            document.getElementById('lang-ui-bgm').textContent = ui.bgm;
            document.getElementById('lang-ui-sfx').textContent = ui.sfx;
            document.getElementById('lang-ui-voice').textContent = ui.voice;
            <span class="setting-label" id="lang-ui-fullscreen">&#20840;&#34722;&#24149;&#39023;&#31034;</span>
            const autoEl = document.getElementById('lang-ui-auto');
            if (autoEl) autoEl.textContent = ui.autoPlay;
            document.getElementById('lang-ui-lang').textContent = ui.lang;
            document.getElementById('close-settings').textContent = ui.closeSet;

            document.getElementById('tog-fs-off').textContent = ui.off;
            document.getElementById('tog-fs-on').textContent = ui.on;
            document.getElementById('tog-lang-tw').textContent = ui.tw;
            document.getElementById('tog-lang-jp').textContent = ui.jp;
            document.getElementById('tog-lang-en').textContent = ui.en;
        }

        function setToggle(group, val) {
            const map = {
                fs: { ids: ['tog-fs-off', 'tog-fs-on'], vals: ['off', 'on'] },
                auto: { ids: ['tog-auto-off', 'tog-auto-on'], vals: ['off', 'on'] }
            };
            if (map[group]) {
                map[group].ids.forEach((id, i) =>
                    document.getElementById(id).classList.toggle('on', map[group].vals[i] === val)
                );
            }
            if (group === 'auto') autoPlay = (val === 'on');
        }

        function updateSlider(el) {
            const pct = ((el.value - el.min) / (el.max - el.min) * 100).toFixed(1) + '%';
            el.style.setProperty('--val', pct);
            if (el.id === 'text-speed') textSpeedMs = Math.round(90 - el.value * 8);
            if (el.id === 'bgm-vol') bgmEl.volume = el.value / 100;
        }

        function toggleAutoPlay(btn) {
            autoPlay = !autoPlay;
            btn.classList.toggle('active', autoPlay);
            showToast(autoPlay ? l10n[currentLang].ui.toastAutoOn : l10n[currentLang].ui.toastAutoOff);
            if (autoPlay && !isTyping && lineIndex < script.length - 1) setTimeout(nextLine, 1800);
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => { });
            else document.exitFullscreen();
        }

        // ???? GYROSCOPE PARALLAX (mobile only) ????????????????????????????????????????????????????????????
        // Uses object-position to shift the visible crop of character images ??safe,
        // no edge bleed, no transform override conflicts.
        (function () {
            if (!window.DeviceOrientationEvent) return;
            if (window.matchMedia('(hover: hover)').matches) return; // skip on desktop

            const MAX_SHIFT = 5;   // px: how far image crops can shift
            const SMOOTH = 0.07; // lerp speed (lower = smoother)

            let baseGamma = null, baseBeta = null;
            let targetX = 0, targetY = 0;
            let smoothX = 0, smoothY = 0;

            function lerp(a, b, t) { return a + (b - a) * t; }
            function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

            function onOrientation(e) {
                const gamma = e.gamma != null ? e.gamma : 0;
                const beta = e.beta != null ? e.beta : 0;
                if (baseGamma === null) { baseGamma = gamma; baseBeta = beta; return; }
                const dg = clamp(gamma - baseGamma, -25, 25);
                const db = clamp(beta - baseBeta, -20, 20);
                targetX = (dg / 25) * MAX_SHIFT;
                targetY = (db / 20) * MAX_SHIFT;
            }

            function tick() {
                smoothX = lerp(smoothX, targetX, SMOOTH);
                smoothY = lerp(smoothY, targetY, SMOOTH);

                // Shift the visible crop of every char image via object-position.
                // This never moves the element boundary, so no black edges appear.
                const px = `calc(50% + ${smoothX.toFixed(2)}px)`;
                const py = `calc(50% + ${smoothY.toFixed(2)}px)`;
                document.querySelectorAll('.char-img').forEach(img => {
                    img.style.objectPosition = `${px} ${py}`;
                });

                requestAnimationFrame(tick);
            }

            function startGyro() {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(state => {
                            if (state === 'granted') {
                                window.addEventListener('deviceorientation', onOrientation);
                                requestAnimationFrame(tick);
                            }
                        }).catch(() => { });
                } else {
                    window.addEventListener('deviceorientation', onOrientation);
                    requestAnimationFrame(tick);
                }
            }

            // First tap satisfies iOS gesture requirement for permission dialog
            document.addEventListener('click', startGyro, { once: true });
        })();

        // ???? ASSET PRELOADER FOR GITHUB PAGES ????????????????????????????????????????????????????????????

        const assetsToLoad = [
            'no speak.jpg',
            'blank.jpg',
            'speak.jpg',
            'angry.jpg',
            'BG.jpg',
            'ad630f06-22cd-45a6-842b-1e8e78c36a61.jpg',
            'fox-face_1f98a.png'
        ];

        let loadedAssetsCount = 0;

        function updateLoaderProgress() {
            loadedAssetsCount++;
            const pct = Math.floor((loadedAssetsCount / assetsToLoad.length) * 100);
            document.getElementById('loading-bar-fill').style.width = pct + '%';
            document.getElementById('loading-text').textContent = `Loading Assets... ${pct}%`;

            if (loadedAssetsCount >= assetsToLoad.length) {
                setTimeout(() => {
                    document.getElementById('loading-container').style.display = 'none';
                    document.getElementById('start-btn').style.display = 'block';
                }, 400);
            }
        }

        function startAssetLoader() {
            assetsToLoad.forEach(src => {
                if (src.endsWith('.wav') || src.endsWith('.mp3')) {
                    const audio = new Audio();
                    audio.oncanplaythrough = updateLoaderProgress;
                    audio.onerror = updateLoaderProgress; // fallback to avoid hard lock
                    audio.src = src;
                } else {
                    const img = new Image();
                    img.onload = updateLoaderProgress;
                    img.onerror = updateLoaderProgress;
                    img.src = src;
                }
            });
        }

        // ???? MAP AND HISTORY ????????????????????????????????????????????????????????????????????????????????????????????

        function openSocial() {
            if (confirm(l10n[currentLang].ui.socialPrompt)) {
                window.open('https://www.facebook.com/teru.fox', '_blank');
            }
        }

        const mapOverlay = document.getElementById('map-overlay');
        const histOverlay = document.getElementById('history-overlay');

        function openMap() { mapOverlay.classList.remove('hidden'); }
        function closeMap(e) { if (e) e.stopPropagation(); mapOverlay.classList.add('hidden'); }

        const dialogueHistory = []; // Stores {speaker, text, isChoice}

        function openHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            if (dialogueHistory.length === 0) {
                list.innerHTML = `<div class="history-entry"><div class="history-text" style="text-align:center; opacity:0.5;">${l10n[currentLang].ui.noHistory}</div></div>`;
            } else {
                dialogueHistory.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'history-entry';
                    if (r.isChoice) {
                        div.innerHTML = `<div class="history-text history-choice">??${r.text}</div>`;
                    } else {
                        div.innerHTML = `
                            <div class="history-speaker">${r.speaker}</div>
                            <div class="history-text">${r.text}</div>
                        `;
                    }
                    list.appendChild(div);
                });
            }
            histOverlay.classList.remove('hidden');

            // Scroll to bottom
            setTimeout(() => { list.scrollTop = list.scrollHeight; }, 10);
        }

        function closeHistory() { histOverlay.classList.add('hidden'); }
        function handleHistoryClick(e) { if (e.target === histOverlay) closeHistory(); }

        // function showHistory() { showToast('?? ??????????????????); } (Replaced by real history panel)

        // ???? Game Flow Control ????????????????????????????????????????????????????????????????????????????????????????
        function startGame() {
            ensureAudio();
            startBGM();
            document.getElementById('title-screen').classList.add('hidden');

            // Thorough state reset to prevent stale state from previous session
            clearInterval(typeTimer);
            typeTimer = null;
            lineIndex = 0;
            charIndex = 0;
            isTyping = false;
            inChoiceMode = false;
            isDeathSequence = false;
            isAngry = false;
            dialogueHistory.length = 0;

            // Reset UI elements that may be dirty
            dialogueArea.classList.remove('choices-mode');
            choicePanel.classList.remove('visible');
            dialogueText.textContent = '';
            document.getElementById('chapter-badge').style.opacity = '1';
            document.getElementById('chapter-badge').style.pointerEvents = 'auto';

            // Clear any inline styles that could interfere with hiding/showing
            document.getElementById('title-screen').style.opacity = '';
            document.getElementById('title-screen').classList.add('hidden');
            cancelOOXXTransitions('startGame reset');
            document.getElementById('ooxx-screen').classList.add('hidden');
            const ooxxResultEl = document.getElementById('ooxx-result');
            ooxxResultEl.classList.add('hidden');
            ooxxResultEl.classList.remove('show-text');

            // Fade out BG.jpg splash as character fades in
            const splash = document.getElementById('bg-splash');
            if (splash) splash.classList.add('fade-out');

            clearTimeout(blinkTimeout);
            stopSpeakingAnimation();
            setCharState('idle');
            scheduleNextBlink();
            // Wait for BG.jpg to finish fading (1.4s) before starting dialogue
            setTimeout(() => renderLine(0), 1400);
        }

        function transitionToTitleWithCover(sourceOverlayEl, cleanupFn) {
            if (typeof cleanupFn === 'function') cleanupFn();
            const title = document.getElementById('title-screen');
            title.style.opacity = '';
            title.classList.remove('hidden');
            setTimeout(() => {
                if (sourceOverlayEl) {
                    sourceOverlayEl.classList.add('hidden');
                    sourceOverlayEl.classList.remove('show-text');
                }
            }, OVERLAY_FADE_MS + 40);
        }

        function returnToTitle(sourceOverlayEl, cleanupFn) {
            // Stop logic / reset
            clearInterval(typeTimer);
            isDeathSequence = false;
            isAngry = false;
            setCharState('idle'); // revert character to idle
            dialogueText.textContent = ''; // clear text
            cancelOOXXTransitions('returnToTitle reset');
            transitionToTitleWithCover(sourceOverlayEl, cleanupFn);
        }

        // ???? Start ????????????????????????????????????????????????????????????????????????????????????????????????????????????????
        scheduleNextBlink();
        // Do not renderLine(0) immediately, wait for Start
        // renderLine(0);
    </script>
    <script type="module" src="./src/js/main.js"></script>
</body>

</html>
